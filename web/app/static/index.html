<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Product Importer</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .section { margin-bottom: 40px; }
    #progress-container {
      width: 100%; 
      background-color: #eee; 
      border-radius: 5px; 
      overflow: hidden; 
      margin-top: 10px;
      height: 25px;
    }
    #progress-bar {
      height: 100%; 
      width: 0%; 
      background-color: #4caf50; 
      text-align: center; 
      color: white; 
      line-height: 25px; 
      transition: width 0.2s ease;
    }
    #status { margin-top: 5px; color: #555; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Product Importer</h1>
  <div class="section">
    <button onclick="window.location.href='/products_ui'">Go to Product Management</button>
    <button onclick="window.location.href='/webhooks_ui'">Go to Webhook Management</button>
  </div>
  <div class="section">
    <h2>Upload CSV</h2>
    <input type="file" id="csvFile" />
    <button onclick="uploadFile()">Upload</button>

    <div id="progress-container">
      <div id="progress-bar">0%</div>
    </div>
    <div id="status">Waiting for upload...</div>
  </div>

  <script>
    function uploadFile() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      if (!file) return alert('Please select a CSV file');

      // Reset progress display
      const progressBar = document.getElementById('progress-bar');
      progressBar.style.width = '0%';
      progressBar.innerText = '0%';
      document.getElementById('status').innerText = "Starting import...";

      const formData = new FormData();
      formData.append('file', file);

      fetch('/upload', { method: 'POST', body: formData })
        .then(resp => resp.json())
        .then(data => {
          const taskId = data.task_id;
          if (!taskId) {
            alert('Upload proper file.');
            return;
          }

          const evt = new EventSource(`/events/${taskId}`);
          evt.onmessage = function(e) {
            try {
              const msg = JSON.parse(e.data);
              progressBar.style.width = msg.progress + '%';
              progressBar.innerText = msg.progress + '%';
              document.getElementById('status').innerText = msg.status;

              if (msg.progress >= 100) {
                evt.close();
                document.getElementById('status').innerText = "Import complete!";
              }
            } catch(err) {
              console.error('SSE parse error', e.data, err);
            }
          };

          evt.onerror = function(e) {
            console.error('SSE error', e);
            evt.close();
            document.getElementById('status').innerText = "Connection lost. Please refresh.";
          };
        })
        .catch(err => {
          console.error('Upload failed:', err);
          alert('Failed to upload file.');
        });
    }
  </script>
</body>
</html>
